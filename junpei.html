<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Location-based AR.js demo</title>
    <!-- バージョンを固定した依存関係 -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script>
      // 方位計算用関数
      function calculateBearing(lat1, lon1, lat2, lon2) {
        const toRadians = degrees => degrees * Math.PI / 180;
        const toDegrees = radians => radians * 180 / Math.PI;

        const dLon = toRadians(lon2 - lon1);
        const lat1Rad = toRadians(lat1);
        const lat2Rad = toRadians(lat2);

        const y = Math.sin(dLon) * Math.cos(lat2Rad);
        const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                  Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
        const bearing = toDegrees(Math.atan2(y, x));
        return (bearing + 360) % 360;  // 0-360度に変換
      }

      // カスタムコンポーネントの登録
      AFRAME.registerComponent('distance-check', {
        init: function() {
          this.target = document.querySelector('#text');
          this.debugEl = document.querySelector('#debug');
        },
        tick: function() {
          const gpsCamera = this.el.components['gps-camera'];
          if (gpsCamera && gpsCamera.currentCoords) {
            const lat = gpsCamera.currentCoords.latitude;
            const lon = gpsCamera.currentCoords.longitude;

            // 目的地
            const targetLat = 35.655131122002594;
            const targetLon = 139.54357446812347;

            // 距離計算
            const distance = gpsCamera.computeDistanceMeters(
              {latitude: lat, longitude: lon},
              {latitude: targetLat, longitude: targetLon}
            );

            // 方位計算
            const bearing = calculateBearing(lat, lon, targetLat, targetLon);

            // デバッグ情報更新
            this.debugEl.textContent = `あと ${distance.toFixed(2)}m / 方位: ${bearing.toFixed(2)}度`;
            this.target.setAttribute('value', `あと ${distance.toFixed(2)}m / 方位: ${bearing.toFixed(2)}度`);
          }
        }
      });
    </script>
    <style>
      #debug {
        position: fixed;
        z-index: 10000;
        background-color: #fff;
        padding: 10px;
        top: 0;
        left: 0;
        display: block;
      }
      .ar-button {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: #fff;
        border: none;
        border-radius: 5px;
        z-index: 10000;
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <div id="debug">読み込み中...</div>
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
    >
      <a-box
        material="color: red"
        gps-entity-place="latitude: 35.655131122002594; longitude: 139.54357446812347"
        scale="15 15 15"
      ></a-box>
      <a-text
        id="text"
        value="待機中..."
        look-at="[gps-camera]"
        scale="30 30 30"
        position="0 55 0"
        gps-entity-place="latitude: 35.655131122002594; longitude: 139.54357446812347"
      ></a-text>
      <a-camera
        gps-camera="minDistance: 1;"
        rotation-reader
        distance-check
      ></a-camera>
    </a-scene>

    <button class="ar-button" id="start-button">AR開始</button>

    <script>
      window.onload = () => {
        const debug = document.querySelector('#debug');
        const startButton = document.querySelector('#start-button');

        // GPSの権限確認
        function requestGPSPermission() {
          return new Promise((resolve, reject) => {
            if ("geolocation" in navigator) {
              navigator.geolocation.getCurrentPosition(
                position => {
                  debug.textContent = 'GPS準備完了2';
                  resolve(position);
                },
                error => {
                  debug.textContent = 'GPS権限エラー';
                  reject(error);
                }
              );
            } else {
              debug.textContent = 'GPS非対応';
              reject(new Error('Geolocation not supported'));
            }
          });
        }

        startButton.addEventListener('click', async () => {
          try {
            await requestGPSPermission();
            startButton.style.display = 'none';
          } catch (error) {
            console.error('GPS error:', error);
            debug.textContent = 'GPSエラー: ' + error.message;
          }
        });

        // システムの状態監視
        const scene = document.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          debug.textContent = 'システム準備完了';
        });

        scene.addEventListener('arjs-video-loaded', () => {
          debug.textContent = 'カメラ準備完了';
        });

        window.addEventListener('gps-camera-update-position', (e) => {
          const position = e.detail.position;
          console.log('GPS position:', position);
        });
      };
    </script>
  </body>
</html>
